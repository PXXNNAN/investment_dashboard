{% extends "base.html" %}
{% block title %}Dividend Analysis{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h2 class="fw-bold text-warning"><i class="fas fa-chart-line me-2"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏• (Dividend Analysis)</h2>
    <h5 class="text-muted">- ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î -</h5>
</div>

<!-- üî• ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Filter Toggle) üî• -->
<div class="d-flex justify-content-center mb-4">
    <div class="btn-group" role="group">
        <a href="/dashboard/dividend-yoy?mode=yearly" class="btn {{ 'btn-primary' if selected_mode == 'yearly' else 'btn-outline-primary' }}">
            <i class="fas fa-calendar me-1"></i> ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Yearly)
        </a>
        <a href="/dashboard/dividend-yoy?mode=monthly" class="btn {{ 'btn-primary' if selected_mode == 'monthly' else 'btn-outline-primary' }}">
            <i class="fas fa-calendar-alt me-1"></i> ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly)
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold text-secondary">
                    <i class="fas fa-chart-bar me-2"></i> 
                    {{ '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Annual Total)' if selected_mode == 'yearly' else '‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly Timeline)' }}
                </h6>
            </div>
            <div class="card-body">
                <div style="height: 400px;">
                    <canvas id="analysisChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
<div class="row justify-content-center mt-4">
    <div class="col-md-10">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover text-center mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Time)</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏ô‡∏ú‡∏• (Amount)</th>
                                <th>‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (Growth)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set ns = namespace(prev=0) %}
                            {% for i in range(chart_data.labels|length) %}
                                {% set curr = chart_data.datasets[0].data[i] %}
                                <tr>
                                    <td class="fw-bold">{{ chart_data.labels[i] }}</td>
                                    <td class="text-success fw-bold">‡∏ø{{ "{:,.2f}".format(curr) }}</td>
                                    <td>
                                        {% if ns.prev > 0 %}
                                            {% set growth = ((curr - ns.prev) / ns.prev) * 100 %}
                                            <span class="badge {{ 'bg-success' if growth > 0 else 'bg-danger' }}">
                                                {{ "{:+.2f}%".format(growth) }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% set ns.prev = curr %}
                            {% else %}
                                <tr><td colspan="3" class="text-muted py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chartData = {{ chart_data | tojson | default('{}') }};
        const mode = '{{ selected_mode }}';
        
        if (chartData.datasets && chartData.datasets.length > 0) {
            const ctx = document.getElementById('analysisChart').getContext('2d');
            new Chart(ctx, {
                type: mode === 'monthly' ? 'line' : 'bar', // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ' ‡∏ø' + new Intl.NumberFormat('en-US').format(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    },
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Monthly ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ï‡πâ‡∏Å‡∏£‡∏≤‡∏ü
                    elements: {
                        line: {
                            fill: mode === 'monthly'
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}